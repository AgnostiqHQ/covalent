# Copyright 2021 Agnostiq Inc.
#
# This file is part of Covalent.
#
# Licensed under the Apache License 2.0 (the "License"). A copy of the
# License may be obtained with this software package or at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Use of this file is prohibited except in compliance with the License.
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: man_1_push_to_master

on:
  workflow_dispatch:
    inputs:
      check_assign_version:
        type: boolean
        required: true
        default: true
        description: "WARNING: Make sure the `man_0_assign_version` workflow has passed successfully before running this workflow.
        Uncheck this box if it has."

permissions:
  id-token: write
  contents: read

jobs:
  push_to_master:
    name: Push develop to master
    runs-on: ubuntu-latest
    outputs:
      release: ${{ steps.push.outputs.release }}

    steps:
      - name: Get all the tags
        id: query-tags
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/AgnostiqHQ/covalent/tags
        env:
          GITHUB_TOKEN: ${{ secrets.COVALENT_OPS_BOT_TOKEN }}

      - name: Parse the latest tag
        id: get-latest-tag
        run: |
          # This assumes that the response from the API is sorted in decreasing order (thus the first element is the latest tag)
          # Remember, the latest tag IS NOT necessarily the latest released version, i.e.,
          # the latest tag can be 0.220.0post2, but the latest release/pre-release is actually 0.228.0rc0,
          # which is why it SHOULD NOT be used in place of the latest version (for example when incrementing the version number).
          latest_tag=${{ fromJSON(steps.query-tags.outputs.data)[0].name }}
          echo "::set-output name=tag::${latest_tag}"

      - name: Get versions of develop and master
        id: get-versions
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false
        run: |
          develop_version="$(cat ./VERSION)"
          master_version="$(git show origin/master:VERSION)"
          echo "::set-output name=develop_version::${develop_version}"
          echo "::set-output name=master_version::${master_version}"

      - name: Perform the push to master
        id: push
        if: >
          !github.event.inputs.check_assign_version
        run: |
          DEVELOP_VERSION="${{ steps.get-versions.outputs.develop_version }}"
          MASTER_VERSION="${{ steps.get-versions.outputs.master_version }}"
          release=false
          echo "Develop version: ${DEVELOP_VERSION}"
          echo "Master version: ${MASTER_VERSION}"
          if [[ "${DEVELOP_VERSION}" == "${MASTER_VERSION}" ]]; then
            echo "No new version detected. Exiting."
            exit 1
          elif dpkg --compare-versions $DEVELOP_VERSION 'gt' $MASTER_VERSION ; then
            echo "Pushing to master."
            git config user.name "CovalentOpsBot"
            git config user.email "covalentopsbot@users.noreply.github.com"
            git remote set-url origin https://${{ secrets.COVALENT_OPS_BOT_TOKEN }}@github.com/AgnostiqHQ/covalent.git
            git push origin HEAD:master
            release=true
          else
            echo "This means the version on develop is lower than the version on master or something is wrong."
            exit 1
          fi
          echo "Ready to release: ${release}"
          echo "::set-output name=release::$release"
